@page "/"
@using Kantineapp.Services
@inject IEventService EventService
@inject IOpgaveService OpgaveService
@inject IBrugerService BrugerService

<div class="container-layout">
    <!-- Event List -->
    <div class="event-list">
        <h3 class="mb-4">Oversigt</h3>
        <a class="btn btn-info mb-3" href="/mineopgaver">Se Mine Opgaver</a>
        <!-- Fejlbesked -->
        @if (!string.IsNullOrEmpty(errorMessage))
        {
        <div class="alert alert-danger">@errorMessage</div>
        }

        @if (isLoading)
        {
        <p>Indlæser events...</p>
        }
        else if (events == null || !events.Any())
        {
        <p>Ingen events fundet.</p>
        }
        else
        {
        <ul class="list-group">
            @foreach (Core.Models.Event ev in events)
            {
            <li class="list-group-item">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <strong>@ev.Name</strong> - @ev.Dato.ToShortDateString() - Lokation: @ev.Lokation
                        <br />
                        Kunde: @ev.Kunde - Madvalg: @ev.MadValg - Særlige ønsker: @ev.SærligeØnsker - Deltagerantal: @ev.DeltagerAntal
                    </div>
                    <div>
                        <button class="btn btn-primary btn-sm me-2" @onclick="() => ToggleTasks(ev.Id)">
                            @(selectedEventId == ev.Id ? "Luk Opgaver" : "Vis Opgaver")
                        </button>
                    </div>
                </div>

                @if (selectedEventId == ev.Id)
                {
                <div class="mt-3">
                    <h5>Opgaver</h5>
                    @if (!tasks.Any())
                    {
                    <p>Ingen opgaver fundet.</p>
                    }
                    else
                    {
                    <ul class="list-group">
                        @foreach (var task in tasks)
                        {
                        <li class="list-group-item">
                            <div>
                                <strong>Opgave:</strong> @task.Beskrivelse
                                <br />
                                <strong>Status:</strong> @task.Status
                                <br />
                                <strong>Start:</strong> @task.StartTid | <strong>Slut:</strong> @task.SlutTid
                                <br />
                                <strong>Opgavetype:</strong> @task.OpgaveType
                                <br />
                                <strong>Ansvarlige Medarbejdere:</strong>
                                @if (task.AnsvarligForOpgave != null && task.AnsvarligForOpgave.Any())
                                {
                                <ul class="mt-2">
                                    @foreach (var medarbejderId in task.AnsvarligForOpgave)
                                    {
                                    var medarbejder = employees.FirstOrDefault(e => e.Id == medarbejderId);
                                    if (medarbejder != null)
                                    {
                                    <li>
                                        @medarbejder.Navn - <em>Kompetencer:</em> @string.Join(", ", medarbejder.MineKompetencer)
                                    </li>
                                    }
                                    }
                                </ul>
                                }
                                else
                                {
                                <span>Ingen medarbejdere tilknyttet</span>
                                }
                            </div>
                        </li>
                        }
                    </ul>
                    }
                </div>
                }
            </li>
            }
        </ul>
        }
    </div>
</div>

@code {
private List<Core.Models.Event> events = new();
private List<Opgave> tasks = new();
private List<Bruger> employees = new();
private string? selectedEventId;
private string errorMessage = string.Empty;
private bool isLoading = true;

protected override async Task OnInitializedAsync()
{
    await LoadDataAsync();
}

private async Task LoadDataAsync()
{
    isLoading = true;
    errorMessage = string.Empty;
    try
    {
        await LoadEvents();
    }
    catch (Exception ex)
    {
        errorMessage = "Kunne ikke indlæse data.";
        Console.WriteLine($"Fejl: {ex.Message}");
    }
    finally
    {
        isLoading = false;
    }
}

private async Task LoadEvents()
{
    try
    {
        events = (await EventService.GetAllEventsAsync()).ToList();
    }
    catch (Exception ex)
    {
        errorMessage = "Kunne ikke indlæse events.";
        Console.WriteLine($"Fejl: {ex.Message}");
    }
}

private async Task ShowTasks(string eventId)
{
    selectedEventId = eventId;
    try
    {
        await LoadEmployees();
        var allTasks = await OpgaveService.GetAllOpgaverAsync();
        tasks = allTasks.Where(t => t.EventId == eventId).ToList();
    }
    catch (Exception ex)
    {
        errorMessage = "Kunne ikke indlæse opgaver.";
        Console.WriteLine($"Fejl: {ex.Message}");
    }
}

private async Task LoadEmployees()
{
    try
    {
        employees = (await BrugerService.GetUsersByRoleAsync(Rolle.Medarbejder)).ToList();
    }
    catch (Exception ex)
    {
        errorMessage = "Kunne ikke indlæse medarbejdere.";
        Console.WriteLine($"Fejl: {ex.Message}");
    }
}

private async Task ToggleTasks(string eventId)
{
    if (selectedEventId == eventId)
    {
        selectedEventId = null;
        tasks.Clear();
    }
    else
    {
        await ShowTasks(eventId);
    }
}
}
